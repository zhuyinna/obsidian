
## 并行加速

使用并行处理或批量处理来加速处理图片和生成姿态信息文件是一个很好的方法。特别是在处理大量图像数据时，单线程执行可能会非常慢。在Python中，有几种方法可以实现并行处理：

### 1. **使用多线程（`threading` 模块）**

多线程适用于I/O密集型任务，比如大量的文件读写操作，但在Python中由于全局解释器锁（GIL），它并不适用于CPU密集型任务。在你的场景中，如果 `OpenposeDetector` 主要进行I/O操作或调用外部非Python代码（如C/C++扩展），多线程可能会有所帮助。

### 2. **使用多进程（`multiprocessing` 模块）**

多进程可以绕过GIL的限制，使得每个进程可以充分利用一个CPU核心。这对于计算密集型任务非常有效，例如图像处理或机器学习模型的推理。

### 3. **使用并行库（如 `concurrent.futures`）**

`concurrent.futures` 提供了一个高级接口，用于异步执行调用。它支持多线程和多进程模式，使得代码更简洁易懂。

```python
import os
import cv2
import concurrent.futures
from annotator.util import resize_image, HWC3
from annotator.openpose import OpenposeDetector

def process_image(img_path, annotation_path):
    apply_openpose = OpenposeDetector()
    input_image = cv2.imread(img_path)
    if input_image is None:
        logger.error("Image could not be loaded. Please check the path.")
        return
    
    input_image = HWC3(input_image) 
    input_image = cv2.resize(input_image, (256, 256))

    detected_map, dic = apply_openpose(input_image)
    logger.info(f"detected_map shape: {detected_map.shape}")
    sv(detected_map)
    # Generate txt file
    img_name = os.path.basename(img_path)
    txt_path = os.path.join(annotation_path, os.path.splitext(img_name)[0]+'.txt')
    os.makedirs(os.path.dirname(txt_path), exist_ok=True)
    with open(txt_path, 'w') as f:
        for k in range(18):
            f.write(f"{dic['candidate'][k][0]} {dic['candidate'][k][1]}\n")
    logger.info(f"Generated {txt_path} successfully.")

def process_folder(frames_path, annotation_path):
    img_list = [os.path.join(dp, f) for dp, dn, filenames in os.walk(frames_path) for f in filenames if os.path.splitext(f)[1].lower() in ['.png', '.jpg', '.jpeg']]
    with concurrent.futures.ProcessPoolExecutor() as executor:
        for img_path in img_list:
            executor.submit(process_image, img_path, annotation_path)

def process():
    process_folder("/home/ynzhu/workspace/dataset/posewarp/train/frames", "/home/ynzhu/workspace/dataset/posewarp/train/annotation")
    process_folder("/home/ynzhu/workspace/dataset/posewarp/test/frames", "/home/ynzhu/workspace/dataset/posewarp/test/annotation")

if __name__ == '__main__':
    process()
    logger.info("Done!")

```