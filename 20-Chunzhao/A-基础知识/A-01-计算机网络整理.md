![[Pasted image 20240330113224.png]]


# TCP篇

```ad-question
SYN 报文什么时候情况下会被丢弃
```
情况1：开启 tcp_tw_recycle 参数，并且在 NAT 环境下，造成 SYN 报文被丢弃
	如果同时开启了recycle 和 timestamps 选项，则会开启一种称之为「 per-host 的 PAWS 机制」。PAWs机制会自动丢弃满足序列、但是时间戳更小的SYN包。 PAWS要求双方维护最近的时间戳，如果收到的包中时间戳不是最新的，丢弃。本质原因：per-host 的 PAWS 机制是对端IP做检查，而不是IP+端口四元组做检查，而客户端环境的每一台机器通过NAT网关都是相同的IP地址（对于服务端来说）。
情况2：TCP 两个队列满了（半连接队列和全连接队列），造成 SYN 报文被丢弃
- 情况2.1 ：半连接满了
	- 解决：开启syncookie功能，满了的情况下，会生成cookie，放在己方发出的 SYN+ACK 报文中发出，当客户端返回 ACK 报文时，取出该值验证，如果合法，就认为连接建立成功；增大半连接队列；减少ACK+SYN重传次数。
- 情况2.2：全连接满了
	- 解决：调大队列；检查为什么accept()不及时。
	


