# 条件随机场CRF

条件随机场CRF(Conditional Random Field) 是给定一组输入随机变量条件下，另一组输出随机变量的条件概率分布模型，其特点是假设输出变量构成马尔可夫随机场。

## 应用场景

为了让分类器表现更好, 在标记数据的时候可以考虑相邻数据的标记信息

- 序列标注
- 分词: 词性标注、命名实体识别

## 随机场到马尔可夫随机场

随机场是一种概率图模型，由无向图表示，由一组随机变量和这些随机变量的联合概率分布组成. 具体来说就是由若干个位置组成的整体, 当给每一个位置中按照某种分布随即赋予一个值之后, 其全体就叫做随机场。随机场分为马尔可夫随机场和高斯随机场。

马尔可夫随机场是一种特殊的随机场，是一种无向图模型，其节点集合为随机变量集合，边集合表示随机变量之间的概率依赖关系。给定随机变量集合$X = {X_1, X_2, ..., X_n}$，对任意结点$i$，$X_i$为$X$的一个子集，$X_i$对应一个随机变量。若随机变量$X_i$与$X_j$之间有边相连，则称$X_i$与$X_j$有关联。若给定随机变量集合$X$，对联合概率分布$P(X)$满足成对、局部、全局马尔可夫性，则称$P(X)$为马尔可夫随机场。

e.g. 句子词性标注: 如果假设所有词的词性只和它相邻的词的词性有关时，这个随机场就特化成一个马尔科夫随机场。比如第三个词的词性除了与自己本身的位置有关外，只与第二个词和第四个词的词性有关。　

## 条件随机场

条件随机场是马尔可夫随机场的特例. 它假设马尔科夫随机场中只有X和Y两种变量，X一般是给定的，而Y一般是在给定X的条件下的输出。

## 线性链条件随机场

线性链条件随机场是条件随机场的一个特例，是一种判别模型。线性链条件随机场是给定输入随机变量序列$X = {X_1, X_2, ..., X_n}$，输出随机变量序列$Y = {Y_1, Y_2, ..., Y_n}$，条件概率分布$P(Y|X)$由以下定义：

$$P(Y|X) = \frac{1}{Z(X)} exp(\sum_{i=1}^{n} \sum_{k=1}^{K} \lambda_k t_k (y_{i-1}, y_i, X, i))$$

> 推导: 线性CRF转化为可以学习的机器模型
> 在线性链CRF中, 特征函数分为两类:
> 1. 定义在Y节点上的**节点特征函数**，这类特征函数只和当前节点有关，记为
> $$s_i(y_i, X, i)$$
> 2. 定义在Y节点之间的**边特征函数**，这类特征函数只和当前节点和前一个节点有关，记为
> $$t_k(y_{i-1}, y_i, X, i)$$
> 无论是节点特征函数还是局部特征函数，它们的取值只能是0或者1。即满足特征条件或者不满足特征条件。同时，我们可以为每个特征函数赋予一个权值，用以表达我们对这个特征函数的信任度。
> 假设tk的权重系数是λk, sl的权重系数是μl, 那么我们可以定义线性链条件随机场的特征函数为
> $$Φ(y, X) = Σ_{i=1}^{n} Σ_{k=1}^{K} λ_k t_k(y_{i-1}, y_i, X, i) + Σ_{i=1}^{n} Σ_{l=1}^{L} μ_l s_l(y_i, X, i)$$
> 其中Z(x)为规范化因子，是所有可能的输出序列的特征函数的权重和，即:
> $$Z(X) = Σ_{y} exp(Φ(y, X))$$
> 其中$Φ(y, X)$为:
> $$Φ(y, X) = Σ_{i=1}^{n} Σ_{k=1}^{K} λ_k t_k(y_{i-1}, y_i, X, i) + Σ_{i=1}^{n} Σ_{l=1}^{L} μ_l s_l(y_i, X, i)$$

## 简化形式
用一个特征函数fk来统一表示节点特征函数和边特征函数:
$$
f_k(y_{i-1}, y_i, X, i) = \left\{
    \begin{array}{rcl}
    s_k(y_i, X, i) & & {k = 1, 2, ..., K_1} \\
    t_k(y_{i-1}, y_i, X, i) & & {k = K_1+1, K_1+2, ..., K}
    \end{array} \right.
$$

$f_k(y_{i-1}, y_i, X, i)$对各个序列位置求和:
$$
f_k(y, X) = \sum_{i=1}^{n} f_k(y_{i-1}, y_i, X, i)
$$

$f_k(y_{i-1}, y_i, X, i)$对应的权重系数如下:
$$
\omega_k = \left\{
    \begin{array}{rcl}
    \mu_k & & {k = 1, 2, ..., K_1} \\
    \lambda_{k-K_1} & & {k = K_1+1, K_1+2, ..., K}
    \end{array} \right.
$$


linear-CRF的参数化形式简化为:
$$
P(Y|X) = \frac{1}{Z(X)} exp(Φ(y, X)) = \frac{1}{Z(X)} exp(\sum_{k=1}^{K} \omega_k f_k(y, X))
$$

Z(x)为规范化因子:
$$
Z(X) = \sum_{y} exp(\sum_{k=1}^{K} \omega_k f_k(y, X))
$$

矩阵形式:
定义一个mxm的矩阵M, m为y的所有可能状态的取值个数, M定义如下:
$$
M = \begin{bmatrix}
exp(\omega_1 f_1(y_1, X)) & exp(\omega_2 f_2(y_1, X)) & ... & exp(\omega_K f_K(y_1, X)) \\
exp(\omega_1 f_1(y_2, X)) & exp(\omega_2 f_2(y_2, X)) & ... & exp(\omega_K f_K(y_2, X)) \\
... & ... & ... & ... \\
exp(\omega_1 f_1(y_m, X)) & exp(\omega_2 f_2(y_m, X)) & ... & exp(\omega_K f_K(y_m, X)) \\
\end{bmatrix}
$$

引入起点和终点标记: $



        


